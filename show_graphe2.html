<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>OpenSFM</title>
    <link rel="stylesheet" href="lib/leaflet/leaflet.css" />
    <script src="lib/leaflet/leaflet.js"></script>
    <!-- <script src="lib/axios.min.js"></script> -->
    <script src="lib/axios.min.js"></script>
    <script src="lib/querystring.min.js"></script>
    <style>
    html, body{
      margin:0px;
      padding:0px;
      width: 100%;
      height: 100%;
      display: flex;
    }

    #map{
      margin:0px;
      padding:0px;
      width: 100%;
      height: 100%;
    }
    </style>
</head>
<body>
    <div id="map"></div>
    <button onclick="myFunction()">Load Data</button>

    <script>

      var query=querystring.parse();
      var to_download0=query["name"];
      var show_marker = query["marker"];
      var to_download="/" + to_download0;
      //Init leaflet map with osm data
      map = new L.Map('map');

      //Create the tile layer with correct attribution
      var osmUrl='http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png';
      var osmAttrib='Map data Â© <a href="http://openstreetmap.org">OpenStreetMap</a> contributors';
      var osm = new L.TileLayer(osmUrl, {minZoom: 8, maxZoom: 19, attribution: osmAttrib});

        function found_node(nodes, node_name){
            for(var indice in nodes){
          element = nodes[indice];
          if(element["id"] === node_name){
            return element;
          }

        }
        return null;

        }
      function add_to_map(test){

        my_nodes = {}

        for(var indice in test["nodes"]){
            element = test["nodes"][indice];
            my_nodes[element["id"]] = element;
        }
        map.eachLayer(function (layer) {
            map.removeLayer(layer);
        });

        for(var name in test["nodes"]){
          element = test["nodes"][name];
          map.setView(new L.LatLng(element["x"], element["y"]), 14);
          map.addLayer(osm);
          break;
        }


        var zoom = 0;
        if(to_download == "/01_points.json"){
          for(var name in test["nodes"]){
            element = test["nodes"][name];
            L.marker([element["point"]["latitude"], element["point"]["longitude"]]).bindPopup(element["name"]).addTo(map);
          }
        }

        var greenIcon = new L.Icon({
          iconUrl: '/img/marker-icon-2x-green.png',
          shadowUrl: '/img/marker-shadow.png',
          iconSize: [25, 41],
          iconAnchor: [12, 41],
          popupAnchor: [1, -34],
          shadowSize: [41, 41]
        });

        for(var name in test["end_points"]){
          var element = my_nodes[test["end_points"][name]];
          L.marker([element["x"], element["y"]], {icon: greenIcon}).bindPopup("EndPoint " + test["end_points"][name]).addTo(map);
        }

        var redIcon = new L.Icon({
          iconUrl: '/img/marker-icon-2x-red.png',
          shadowUrl: '/img/marker-shadow.png',
          iconSize: [25, 41],
          iconAnchor: [12, 41],
          popupAnchor: [1, -34],
          shadowSize: [41, 41]
        });
        /*
        for(var name in test["junctions_point"]){
          var element = test["nodes"][test["junctions_point"][name]];
          L.marker([element["point"]["latitude"], element["point"]["longitude"]], {icon: greenIcon}).bindPopup("Junction Pano " + test["endpoints"][name]).addTo(map);
        }
        */

        for(var name in test["hotpoints"]){

          var element = my_nodes[test["hotpoints"][name]];
          L.marker([element["x"], element["y"]], {icon: redIcon}).bindPopup("HotPoint " + test["hotpoints"][name]).addTo(map);
        }

        for(var indice in test["edges"]){
          element = test["edges"][indice];
          // create a red polyline from an array of LatLng points
          n_source = my_nodes[element["source"]];
          n_dest = my_nodes[element["dest"]];
          var latlngs = [
            [n_source["x"], n_source["y"]],
            [n_dest["x"], n_dest["y"]]
          ];
          var polyline = L.polyline(latlngs, {color: 'red'}).addTo(map);

          // zoom the map to the polyline
          map.fitBounds(polyline.getBounds());
        }
      }
  function myFunction() {
    var txt;
    var person = prompt("Enter graphe in json format", "");
    if (person == null || person == "") {

    } else {
        txt = JSON.parse(person);
        add_to_map(txt)
    }

}
    </script>

</body>
</html>
